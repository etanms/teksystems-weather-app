<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Forecast</title>
  <link rel="stylesheet" href="/assets/forecast.css">
</head>
<body>
<header>
  <h1>Weather Forecast</h1>
  <h4>Cached At: <%= @cached_at.localtime.strftime("%Y-%m-%d %H:%M:%S %Z") %></h4>
</header>

<main>
  <% if @forecast.present? %>
    <div class="forecast">
      <% sorted_days = @forecast.sort_by { |date, _| date } %>

      <% sorted_days.each do |date, data| %>
        <div class="card" data-date="<%= date %>">
          <!-- Always visible summary -->
          <div class="day-summary">
            <div class="title"><%= date.strftime("%A, %b %d, %Y") %></div>
            <div>
              Average: <%= (data[:temperature_sum] / data[:num_periods]).round(1) %>째F,
              High: <%= data[:high] %>째F,
              Low: <%= data[:low] %>째F
            </div>
            <div>Average Humidity: <%= (data[:humidity_sum].to_f / data[:num_periods]).round(1) %>%</div>
            <div>Precipitation Chance: <%= (data[:precipitation_pct].to_f / data[:num_periods]).round(1) %>%</div>
            <div class="forecast-summary">
              <% if data[:forecast].present? %>
                <% condition, details = data[:forecast].max_by { |_, v| v[:count] } %>
                <div>
                  <img src="<%= details[:icon] %>" alt="<%= condition %> icon">
                  <%= condition %>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Expandable hourly section -->
          <div class="hourly-forecast <%= 'expanded' if date == Date.today %>">
            <% if data[:periods].present? %>
              <table>
                <thead>
                <tr>
                  <th>Time</th>
                  <th>Temp (째F)</th>
                  <th>Humidity (%)</th>
                  <th>Wind</th>
                  <th>Forecast</th>
                  <th>Icon</th>
                </tr>
                </thead>
                <tbody>
                <% data[:periods].each do |period| %>
                  <tr>
                    <% time = Time.parse(period['startTime']).localtime rescue nil %>
                    <td><%= time&.strftime("%-I:%M %p") %></td>
                    <td><%= period['temperature'] %></td>
                    <td><%= period['relativeHumidity']&.send(:[], 'value') || 'N/A' %></td>
                    <td><%= period['windDirection'] %> <%= period['windSpeed'] %></td>
                    <td><%= period['shortForecast'] %></td>
                    <td><img src="<%= period['icon'] %>" alt="<%= period['shortForecast'] %>"></td>
                  </tr>
                <% end %>
                </tbody>
              </table>
            <% else %>
              <div>No hourly data available</div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p>No forecast data available.</p>
  <% end %>

  <script>
      document.addEventListener("DOMContentLoaded", () => {
          document.querySelectorAll(".day-summary").forEach(summary => {
              summary.addEventListener("click", () => {
                  const card = summary.closest(".card");
                  const hourlySection = card.querySelector(".hourly-forecast");
                  hourlySection.classList.toggle("expanded");
              });
          });
      });
  </script>
</main>
</body>
